#!/bin/bash
#set -x
git submodule sync --quiet
git submodule update --init

deleted_sections=$(comm -13 <(awk -F '"' '/\[submodule /{print $0}' .gitmodules|sort) <(awk -F '"' '/\[submodule /{print $0}' .git/config|sort))
if [ "$deleted_sections" ]
then
    echo "Removing following submodule sections from .git/config:"
    echo "$deleted_sections"

    pattern=$(echo $deleted_sections|sed 's/\[/\\[/'|sed 's/\]/\\]/'|paste -sd'|')
    cp -f .git/config .git/config-$1
    rm -f .git/config-new
    awk -v pattern="$pattern" '/^\[/{a=1} $0 ~ pattern {a=0} {if (a) print $0}' .git/config > .git/config-new
    mv -f .git/config-new .git/config
    #awk -v pattern="$pattern" '/^\[/{a=0} $0 ~ pattern {a=1} {print a, $0}' .git/config

    deleted_submodules=$(awk -F '"' '{print $2}' <<< "$deleted_sections")
    while read -r submodule_path
    do
        echo "Removing from worktree: $submodule_path"
        git clean -dff "$submodule_path"
    done <<< "$deleted_submodules"
fi
