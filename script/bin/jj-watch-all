#!/usr/bin/env bash
# Periodically snapshot all jj repos

INTERVAL=30

find_jj_dirs() {
    if command -v fd &>/dev/null; then
        fd -H -t d -E '/.jj/' '^\.jj$' "$HOME"
    else
        find "$HOME" -name ".jj" -type d 2>/dev/null | grep -v "/.jj/"
    fi
}

while true; do
    while IFS= read -r jj_dir; do
        jj -R "$(dirname "$jj_dir")" snapshot 2>/dev/null &
    done < <(find_jj_dirs)
    wait
    sleep "$INTERVAL"
done
