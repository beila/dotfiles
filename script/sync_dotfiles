#!/usr/bin/env bash
GIT=${GIT_EXECUTABLE:-git}
GIT_SUBREPO=${GIT_SUBREPO:-git-subrepo}
cd $1 || (echo "NO DIRECTORY: $1"; exit)

$GIT submodule foreach $GIT add --all .
$GIT submodule foreach $GIT commit -m "Change from $(hostname)"
$GIT submodule foreach $GIT pull --no-edit --recurse-submodules=no
$GIT submodule foreach $GIT push

$GIT add --all .
$GIT commit -m "Change from $(dig +short $(hostname))"
$GIT pull --no-edit --recurse-submodules=no && $GIT push \
	&& $GIT_SUBREPO pull -v --all \
    && $GIT pull --no-edit --recurse-submodules=no && $GIT push \
	|| $GIT_SUBREPO clean --all
