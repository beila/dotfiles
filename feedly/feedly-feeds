#!/usr/bin/env -S uv run --script
# /// script
# dependencies = ["selenium"]
# ///

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
import time
import os

def get_feedly_feeds():
    options = Options()
    options.add_argument('--user-agent=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36')
    options.add_argument('--disable-blink-features=AutomationControlled')
    options.add_experimental_option("excludeSwitches", ["enable-automation"])
    options.add_experimental_option('useAutomationExtension', False)
    driver = webdriver.Chrome(options=options)
    driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
    
    try:
        # Go directly to Feedly - fresh session each time
        driver.get("https://feedly.com/i/my")
        time.sleep(3)
        
        # Check if login is needed - always assume login needed if no feeds found
        time.sleep(3)
        current_url = driver.current_url
        print(f"Current URL: {current_url}")
        
        # Check if we can see feeds - if not, we need to login
        try:
            test_elements = driver.find_elements(By.CSS_SELECTOR, ".subscription, .feed-item, .source, [data-feed-id], .entry")
            if len(test_elements) == 0:
                print("No feeds visible - login required")
                needs_login = True
            else:
                print(f"Found {len(test_elements)} elements - appears logged in")
                needs_login = False
        except:
            needs_login = True
        
        if needs_login:
            print("Login required!")
            print("Please login to Feedly in the browser window")
            print("Complete the full Google OAuth process")
            print("DO NOT press Enter until you're back at Feedly and can see your feeds")
            input("Press Enter only when you see your Feedly feed list...")
        else:
            print("Already logged in!")
        
        # Navigate to subscriptions/organize page
        driver.get("https://feedly.com/i/organize")
        time.sleep(3)
        
        feeds = []
        
        # Try different selectors for feed elements
        feed_elements = driver.find_elements(By.CSS_SELECTOR, "[data-feed-id], .subscription, .feed-item, .source")
        
        if not feed_elements:
            # Try alternative approach - get from subscriptions page
            driver.get("https://feedly.com/i/subscriptions")
            time.sleep(3)
            feed_elements = driver.find_elements(By.CSS_SELECTOR, ".subscription, .feed-item, .source, [data-feed-id]")
        
        print(f"Found {len(feed_elements)} potential feed elements")
        
        for i, element in enumerate(feed_elements):
            try:
                # Try multiple ways to get title
                title = ""
                for selector in [".title", ".source-title", "h3", ".name", "[title]"]:
                    try:
                        title_elem = element.find_element(By.CSS_SELECTOR, selector)
                        title = title_elem.text or title_elem.get_attribute("title")
                        if title:
                            break
                    except:
                        continue
                
                # Try to get URL/feed ID
                url = element.get_attribute("data-feed-id") or element.get_attribute("href") or ""
                
                # Try to get velocity/frequency info
                velocity = ""
                for selector in [".velocity", ".frequency", ".posts-per-week", ".activity"]:
                    try:
                        vel_elem = element.find_element(By.CSS_SELECTOR, selector)
                        velocity = vel_elem.text
                        break
                    except:
                        continue
                
                # Try to get category info
                categories = []
                for selector in [".category", ".folder", ".tag", ".collection"]:
                    try:
                        cat_elems = element.find_elements(By.CSS_SELECTOR, selector)
                        categories = [elem.text for elem in cat_elems if elem.text]
                        if categories:
                            break
                    except:
                        continue
                
                if title:  # Only add if we found a title
                    feeds.append({
                        "title": title,
                        "url": url,
                        "velocity": velocity or "Unknown",
                        "categories": categories or ["Uncategorized"]
                    })
                    print(f"Found feed {i+1}: {title}")
                    
            except Exception as e:
                print(f"Error processing element {i}: {e}")
                continue
        
        return feeds
        
    finally:
        driver.quit()

if __name__ == "__main__":
    feeds = get_feedly_feeds()
    print(f"\nFound {len(feeds)} feeds:")
    print("=" * 80)
    for i, feed in enumerate(feeds, 1):
        print(f"{i}. Title: {feed['title']}")
        print(f"   URL: {feed['url']}")
        print(f"   Velocity: {feed['velocity']}")
        print(f"   Categories: {', '.join(feed['categories'])}")
        print("-" * 80)
