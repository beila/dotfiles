#!env zsh
this_dir="$(realpath $(pwd))"
parent_dir="$(realpath $(pwd)/..)"
new_home=${this_dir}/build/home
new_path_array=(${new_home}/*/bin)
new_path=$(print -R ${(j|:|)new_path_array})

image="${1}"
shift
docker run \
    --init \
    --user $(id -u):$(id -g) \
    --volume "${parent_dir}:${parent_dir}" \
    --workdir "${this_dir}" \
    --env HOME=${this_dir}/build/home \
    --env LD_LIBRARY_PATH=build_lsan/linux-sanitiser-lsan-wasm-integration-tests/lib \
    --env ASAN_OPTIONS=allocator_may_return_null=1:detect_leaks=1 \
    --env LSAN_OPTIONS=suppressions=tools/sanitizer-suppression-files/lsan-suppressions.txt:verbosity=1:log_threads=1 \
    "${image}" \
    bash -c "export PATH=${new_path}:\${PATH}; xvfb-run --auto-servernum -e /dev/stderr --server-args='-screen 0 1400x900x24 -ac +extension GLX +render -noreset -nolisten tcp -nolisten unix' $*"
